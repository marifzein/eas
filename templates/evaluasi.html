{% extends "base.html" %}
{% load static %}
{% block title %} 
{{page_title}} 
{% endblock title %}
{% block head %}
<style>
.readonly-quiz {
    pointer-events: none; /* Mencegah semua interaksi mouse */
    user-select: none;    /* Mencegah teks terpilih (opsional) */
  }
  
  .modal-content {
    overflow: hidden;
  }
  .modal-header {
    padding-top: 0px !important;
    text-align: center !important;
    border-radius: 0; /* Removes the default border-radius from the header */
  }
</style>

  <script>
document.addEventListener('DOMContentLoaded', function() {
    const timeLimitMinutes = 8;
    const timeLimitSeconds = timeLimitMinutes * 60;
    const startTime = Date.now();
    const endTime = startTime + timeLimitSeconds * 1000;
    
    // elemen untuk menampilkan timer,  'timerDisplay' .
    
    const timerDisplay = document.getElementById('timerDisplay'); 
    const mainSubmitButton = document.getElementById('mainSubmitButton');
    const modalSubmitButton = document.getElementById('modalSubmitButton');
    const evaluasiForm = document.getElementById('evaluasiForm');

    function updateTimer() {
        const now = Date.now();
        const remainingTime = endTime - now;

        if (remainingTime < 0) {
            // Timer habis: Nonaktifkan tombol dan kirim form jika belum terkirim
            if (mainSubmitButton) {
                mainSubmitButton.disabled = true;
                mainSubmitButton.textContent = "Waktu Habis";
                // Tutup modal jika terbuka
                const modal = bootstrap.Modal.getInstance(document.getElementById('konfirmasiKirimModal'));
                if (modal) {
                    modal.hide();
                }
            }

            // Opsional: Kirim form secara otomatis saat waktu habis (jika belum terkirim)
            // if (evaluasiForm && !evaluasiForm.classList.contains('readonly-quiz')) {
            //     evaluasiForm.submit();
            // }

            // Hentikan timer
            clearInterval(timerInterval);
            if (timerDisplay) timerDisplay.textContent = "Waktu Habis!";
            return;
        }

        const totalSeconds = Math.floor(remainingTime / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;

        // Format waktu (MM:SS)
        const displayTime = 
            String(minutes).padStart(2, '0') + ":" + 
            String(seconds).padStart(2, '0');
        
        if (timerDisplay) {
            timerDisplay.textContent = displayTime;
        }
    }

    // Panggil updateTimer setiap detik
    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer(); // Panggil sekali di awal
});
</script>
{% endblock head %}

{% block navbar %}

{% endblock navbar %}
<!-- pemisah -->
{% block contents %}

<div class="container">
  <div
      style="max-width: 700px; width:70%;border-radius: 25px"
      class="mt-4 card-body shadow mx-auto p-0 bg-light"
    >
    <h3 style="border-top-left-radius: 25px;border-top-right-radius:25px" class="card-title text-center mb-0 bg-primary text-bold text-light p-3 ">
    LEMBAR EVALUASI
</h3>
    <div class="d-flex align-items-center">
      <div class="ms-1 py-2 px-2">
       
        <h4 class="text-center text-success">Soal Pilihan Ganda</h4>
      </div>
      <div class="me-3 ms-auto text-end py-2">
        <div>
          <b class="text-danger {{attr_timer}}">Sisa Waktu: <span id="timerDisplay">08:00</span></b>
        </div>
        <div>
          <b class="text-primary text-bold">{{ user.first_name }} {{ user.last_name}}</b>
        </div>
        <div class="text-secondary">{{user.username}}</div>
      </div>
    </div>
    
    <div class="card-body p-3">
      {% if attr_submit == 'disabled' %}
        <form method="post" class="needs-validation readonly-quiz" id="evaluasiForm">
      {% else %}
        <form method="post" class="needs-validation" id="evaluasiForm">
      {% endif %}
        {% csrf_token %} 
        <!-- pemisah -->

        <!-- modal begin -->
        <div
          class="modal fade"
          id="konfirmasiKirimModal"
          tabindex="-1"
          aria-labelledby="konfirmasiKirimModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-primary">
              <div class="modal-header border-1 mx-auto w-100 bg-primary"
        style="padding-left: 1.5rem !important">
                <h4 class="modal-title" id="konfirmasiKirimModalLabel">
                  Konfirmasi Pengiriman Jawaban
                </h4>
                <button
                  type="button"
                  class="btn-close btn-close-white"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>

              <div class="modal-body text-center p-4 bg-light">
                <h5 class="mb-4">Apakah antum yakin jawaban antum sudah benar?</h5>
                <p class="text-muted">
                  Pilih **YA** untuk mengirim jawaban. Jawaban yang sudah dikirim tidak dapat diubah.
                </p>
              </div>

              <div class="d-flex justify-content-center border-0 p-4 bg-light">
                <div class="w-50 p-1">
                  <button
                    type="button"
                    class="w-100 btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    TIDAK
                  </button>
                </div>
                <div class="w-50 p-1">
                  <button 
                    type="submit" 
                    form="evaluasiForm" 
                    class="w-100 btn btn-success"
                    id="modalSubmitButton"
                  >
                    YA, KIRIM JAWABAN
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- modal end-->
        {% for field in form %}
        <div class="mb-3">
          <label class="form-label fw-bold"
            >{{ forloop.counter }}. {{ field.label }}</label
          >
          <div class="form-check">
            {% for radio in field %}
            <div class="form-check">
              {{ radio.tag }}
              <label class="form-check-label" for="{{ radio.id_for_label }}">
                {{ radio.choice_label }}
              </label>
            </div>
            {% endfor %}
          </div>
          {% if field.errors %}
          <div class="text-danger small">{{ field.errors }}</div>
          {% endif %}
        </div>
        {% endfor %}

        <br />
        <button type="button" {{attr_submit}} 
        class="btn btn-primary rounded-pill"
        data-bs-toggle="modal"
        data-bs-target="#konfirmasiKirimModal"
        id="mainSubmitButton">
          Kirim Jawaban
        </button>
      </form>
    </div>
  </div>
  <br />

  {% if hasil %}
  <div
    style="max-width: 700px; width:70%; border-radius: 25px"
    class="mt-3 card-body shadow mx-auto p-0 bg-light"
>
    <h3 style="border-top-left-radius: 25px;border-top-right-radius:25px" class="card-title text-center mb-0 bg-primary text-bold text-light p-3 ">
    Hasil Evaluasi
</h3>
      <div class="d-flex align-items-center">
        <div class="card-body p-3">
          
          
          <h2 class="text-bold">Skor: {{ skor }}</h2>
          <ul>
            {% for id, detail in hasil.items %}
            <strong>{{ forloop.counter }}. {{ detail.pertanyaan }}</strong
            ><br />
            Jawaban Anda: {{ detail.jawaban_user }}
            <br />
            Jawaban Benar: {{ detail.jawaban_benar }}
            <br />
            <h5 class="mt-3">
              {% if detail.benar %}
              <span class="text-success">Benar ✅</span>
              {% else %}
              <span class="text-danger">Salah ❌</span>
              {% endif %}
            </h5>
            {% endfor %}
          </ul>
        </div>
      </div>
  </div>
  {% endif %}
</div>
<!--  modal sukses save-->
<div 
  class="modal fade" 
  id="successModal" 
  tabindex="-1" 
  aria-labelledby="successModalLabel" 
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="successModalLabel">Berhasil!</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body text-center p-4">
        <h5 class="mb-3">Jawaban Evaluasi Anda Telah Terkirim ke Server.</h5>
        {% if skor is not None %}
        <p class="fs-4 text-primary">Skor Anda: <strong>{{ skor }}</strong></p>
        {% endif %}
        <p class="text-muted">Terima kasih telah menyelesaikan evaluasi.</p>
      </div>

      <div class="modal-footer d-flex justify-content-center">
        <a href="{% url 'home' %}" class="btn btn-primary">Kembali ke Beranda</a>
        <a data-bs-dismiss="modal" href="#" class="btn btn-secondary ">Lihat Arsip Jawaban</a>
      </div>
    </div>
  </div>
</div>
{% endblock contents %}
{% block footerscript %}
<script>
// Pastikan variabel Bootstrap sudah tersedia (jika menggunakan Bootstrap 5)

// [1] Cek apakah variabel status tersimpan di database bernilai True ( tersimpan ke dbase)
{% if statSave %}
    // [2] Ambil elemen modal
    const successModalElement = document.getElementById('successModal');
    
    // [3] Buat objek Modal Bootstrap
    const successModal = new bootstrap.Modal(successModalElement);
    
    // [4] Tampilkan modal!
    successModal.show();
    
    // Opsional: Setelah berhasil submit, nonaktifkan tombol submit utama
    const mainSubmitButton = document.getElementById('mainSubmitButton');
    if (mainSubmitButton) {
        mainSubmitButton.disabled = true;
        mainSubmitButton.textContent = "Jawaban Sudah Terkirim";
    }
    
    // Opsional: Nonaktifkan form agar tidak bisa diubah setelah submit
    const evaluasiForm = document.getElementById('evaluasiForm');
    if (evaluasiForm) {
        evaluasiForm.classList.add('readonly-quiz');
    }
{% endif %}
</script>
{% endblock footerscript %}